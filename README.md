# Oiler Backup Operator

[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

**Oiler Backup Operator** — это Kubernetes Operator, предназначенный для автоматизации процессов резервного копирования и восстановления баз данных в Kubernetes-окружениях. Оператор поддерживает несколько типов баз данных (например, PostgreSQL, MongoDB) через архитектуру адаптеров, что обеспечивает гибкость и масштабируемость.

## Содержание

- [Oiler Backup Operator](#oiler-backup-operator)
  - [Содержание](#содержание)
  - [Введение](#введение)
  - [Основные возможности](#основные-возможности)
  - [Архитектура](#архитектура)
  - [Установка](#установка)
    - [Предварительные требования](#предварительные-требования)
    - [Установка с помощью Helm](#установка-с-помощью-helm)
  - [Конфигурация](#конфигурация)
  - [Использование](#использование)
    - [Создание CRD для резервного копирования](#создание-crd-для-резервного-копирования)
  - [Мониторинг](#мониторинг)
  - [Тестирование](#тестирование)
    - [Unit-тесты](#unit-тесты)
    - [Ручное тестирование](#ручное-тестирование)
  - [Лицензия](#лицензия)

---

## Введение

С развитием облачных технологий и переходом компаний на Kubernetes, управление базами данных становится критически важным. Ручное управление резервным копированием и восстановлением баз данных неэффективно и подвержено ошибкам. **Oiler Backup Operator** решает эту проблему, предоставляя универсальное решение для автоматизации этих процессов.

Проект разработан с учетом потребностей DevOps-инженеров, администраторов баз данных и команд разработчиков приложений. Он поддерживает интеграцию с S3-совместимыми хранилищами и предоставляет мониторинг через Prometheus.

---

## Основные возможности

- **Автоматическое резервное копирование**: Настройка периодических бэкапов с использованием CronJobs.
- **Восстановление данных**: Возможность восстановления из последнего или указанного бэкапа.
- **Поддержка нескольких баз данных**: Адаптеры для PostgreSQL, MongoDB и других популярных баз данных.
- **Интеграция с S3-хранилищами**: Хранение бэкапов в MinIO или других S3-совместимых системах.
- **Мониторинг**: Экспорт метрик через Prometheus для отслеживания состояния бэкапов.
- **Гибкость**: Легкое добавление новых адаптеров для поддержки других баз данных.

---

## Архитектура

Проект построен на основе следующих компонентов:

1. **Kubebuilder**: Для создания Custom Resource Definitions (CRD) и логики оператора.
2. **Адаптерная архитектура**: Каждый тип базы данных поддерживается через отдельный адаптер.
3. **S3-Compatible Storage**: Используется для хранения бэкапов.
4. **Prometheus Stack**: Для мониторинга состояния бэкапов и восстановления.
5. **gRPC**: Для взаимодействия между компонентами оператора.

---

## Установка

### Предварительные требования

- Kubernetes версии 1.20+.
- Helm 3.x.
- MinIO или другое S3-совместимое хранилище.

### Установка с помощью Helm

```bash
# Добавьте репозиторий Helm
helm repo add oiler-backup https://your-repo-url

# Установите оператор
helm install oiler-backup oiler-backup/oiler-backup --namespace oiler-system --create-namespace
```

---

## Конфигурация

Настройте параметры оператора через ConfigMap:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: database-config
  namespace: oiler-system
data:
  postgres: "postgres-controller-address"
  mongodb: "mongodb-controller-address"
```

---

## Использование

### Создание CRD для резервного копирования

Пример YAML-файла для создания объекта `BackupRestore`:

```yaml
apiVersion: backup.oiler.backup/v1
kind: BackupRestore
metadata:
  name: example-backuprestore
spec:
  dbUri: "postgres-service"
  dbPort: 5432
  dbUser: "admin"
  dbPass: "password"
  dbName: "example-db"
  databaseType: "postgres"
  s3Endpoint: "http://minio-service:9000"
  s3AccessKey: "minio-access-key"
  s3SecretKey: "minio-secret-key"
  s3BucketName: "backups"
  backupRevision: "0"
```

Примените файл:

```bash
kubectl apply -f backuprestore.yaml
```

---

## Мониторинг

Оператор экспортирует метрики через Prometheus. Пример запросов:

- Количество успешных бэкапов:
  ```promql
  successful_backups_total
  ```

- Количество неудачных бэкапов:
  ```promql
  failed_backups_total
  ```

---

## Тестирование

### Unit-тесты

In progress...

### Ручное тестирование

1. Разверните оператор в тестовом кластере.
2. Создайте объект, например, `BackupRestore`.
3. Проверьте, что бэкап успешно создан и восстановлен.

---

## Лицензия

Этот проект распространяется под лицензией Apache 2.0. Подробности см. в файле [LICENSE](LICENSE).

---

Если у вас возникнут вопросы или предложения, пожалуйста, создайте issue в репозитории или свяжитесь с нами через email.
